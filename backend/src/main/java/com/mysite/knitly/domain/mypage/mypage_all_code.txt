========== FILE PATH: C:\Users\Booj\Desktop\2차프로젝트\2차프로젝트(머지)\backend\src\main\java\com\mysite\knitly\domain\mypage\controller\MyPageController.java ==========
package com.mysite.knitly.domain.mypage.controller;

import com.mysite.knitly.domain.mypage.dto.*;
import com.mysite.knitly.domain.mypage.service.MyPageService;
import com.mysite.knitly.domain.payment.dto.PaymentDetailResponse;
import com.mysite.knitly.domain.payment.service.PaymentService;
import com.mysite.knitly.domain.user.entity.User;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Sort;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.web.bind.annotation.*;

@Slf4j
@RestController
@RequestMapping("/mypage")
@RequiredArgsConstructor
@PreAuthorize("isAuthenticated()")
public class MyPageController {

    private final MyPageService service;
    private final PaymentService paymentService;

    // 프로필 조회 (이름 + 이메일)
    @GetMapping("/profile")
    public ProfileResponse profile(@AuthenticationPrincipal User principal) {
        log.info("[MyPageController] 프로필 조회 요청 - userId={}", principal.getUserId());
        ProfileResponse resp = new ProfileResponse(principal.getName(), principal.getEmail());
        log.info("[MyPageController] 프로필 조회 완료 - userId={}", principal.getUserId());
        return resp;
    }

    // 주문 내역 조회
    @GetMapping("/orders")
    public PageResponse<OrderCardResponse> orders(
            @AuthenticationPrincipal User principal,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "3") int size
    ) {
        log.info("[MyPageController] 주문 내역 조회 요청 - userId={}, page={}, size={}", principal.getUserId(), page, size);
        var result = PageResponse.of(service.getOrderCards(principal.getUserId(), PageRequest.of(page, size)));
        log.info("[MyPageController] 주문 내역 조회 완료 - userId={}, returned={}", principal.getUserId(), result.content().size());
        return result;
    }

    // 주문 내역별 결제 정보 조회
    @GetMapping("/orders/{orderId}/payment")
    public ResponseEntity<?> myOrderPayment(
            @AuthenticationPrincipal User principal,
            @PathVariable Long orderId
    ) {
        log.info("[MyPageController] 결제 상세 조회 요청 - userId={}, orderId={}", principal.getUserId(), orderId);
        PaymentDetailResponse detail = paymentService.getPaymentDetailByOrder(principal, orderId);
        log.info("[MyPageController] 결제 상세 조회 완료 - userId={}, orderId={}", principal.getUserId(), orderId);
        return ResponseEntity.ok(detail);
    }

    // 내가 쓴 글 조회 (검색 + 정렬)
    @GetMapping("/posts")
    public PageResponse<MyPostListItemResponse> myPosts(
            @AuthenticationPrincipal User principal,
            @RequestParam(required = false) String query,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size
    ) {
        log.info("[MyPageController] 내 글 조회 요청 - userId={}, query='{}', page={}, size={}", principal.getUserId(), query, page, size);
        var pageable = PageRequest.of(page, size, Sort.by(Sort.Direction.DESC, "createdAt"));
        var result = PageResponse.of(service.getMyPosts(principal.getUserId(), query, pageable));
        log.info("[MyPageController] 내 글 조회 완료 - userId={}, returned={}", principal.getUserId(), result.content().size());
        return result;
    }

    // 내가 쓴 댓글 조회 (검색 + 정렬)
    @GetMapping("/comments")
    public PageResponse<MyCommentListItem> myComments(
            @AuthenticationPrincipal User principal,
            @RequestParam(required = false) String query,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size
    ) {
        log.info("[MyPageController] 내 댓글 조회 요청 - userId={}, query='{}', page={}, size={}", principal.getUserId(), query, page, size);
        var pageable = PageRequest.of(page, size, Sort.by(Sort.Direction.DESC, "createdAt"));
        var result = PageResponse.of(service.getMyComments(principal.getUserId(), query, pageable));
        log.info("[MyPageController] 내 댓글 조회 완료 - userId={}, returned={}", principal.getUserId(), result.content().size());
        return result;
    }

    // 내가 찜한 상품 조회
    @GetMapping("/favorites")
    public PageResponse<FavoriteProductItem> myFavorites(
            @AuthenticationPrincipal User principal,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size
    ) {
        log.info("[MyPageController] 찜 목록 조회 요청 - userId={}, page={}, size={}", principal.getUserId(), page, size);
        var pageable = PageRequest.of(page, size);
        var result = PageResponse.of(service.getMyFavorites(principal.getUserId(), pageable));
        log.info("[MyPageController] 찜 목록 조회 완료 - userId={}, returned={}", principal.getUserId(), result.content().size());
        return result;
    }

    // 내가 작성한 리뷰 조회
    @GetMapping("/reviews")
    public PageResponse<ReviewListItem> myReviews(
            @AuthenticationPrincipal User principal,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size
    ) {
        log.info("[MyPageController] 내 리뷰 조회 요청 - userId={}, page={}, size={}", principal.getUserId(), page, size);
        var pageable = PageRequest.of(page, size, Sort.by(Sort.Direction.DESC, "createdAt"));
        var result = PageResponse.of(service.getMyReviewsV2(principal.getUserId(), pageable));
        log.info("[MyPageController] 내 리뷰 조회 완료 - userId={}, returned={}", principal.getUserId(), result.content().size());
        return result;
    }
}


========== FILE PATH: C:\Users\Booj\Desktop\2차프로젝트\2차프로젝트(머지)\backend\src\main\java\com\mysite\knitly\domain\mypage\dto\FavoriteProductItem.java ==========
package com.mysite.knitly.domain.mypage.dto;

import java.time.LocalDate;
import java.math.BigDecimal;


// 마이페이지 - 내가 찜한 상품 조회

public record FavoriteProductItem(
        Long productId,
        String productTitle,
        String sellerName,     // (판매자)
        String thumbnailUrl
) {}


========== FILE PATH: C:\Users\Booj\Desktop\2차프로젝트\2차프로젝트(머지)\backend\src\main\java\com\mysite\knitly\domain\mypage\dto\MyCommentListItem.java ==========
package com.mysite.knitly.domain.mypage.dto;

import com.fasterxml.jackson.annotation.JsonFormat;
import java.time.LocalDateTime;

public record MyCommentListItem(
        Long commentId,
        Long postId,

        // 문자열(ISO)로 내려주고 KST 적용
        @JsonFormat(shape = JsonFormat.Shape.STRING,
                pattern = "yyyy-MM-dd'T'HH:mm:ss",
                timezone = "Asia/Seoul")
        LocalDateTime createdAt,

        String preview
) {}


========== FILE PATH: C:\Users\Booj\Desktop\2차프로젝트\2차프로젝트(머지)\backend\src\main\java\com\mysite\knitly\domain\mypage\dto\MyPostListItemResponse.java ==========
package com.mysite.knitly.domain.mypage.dto;

import com.fasterxml.jackson.annotation.JsonFormat;
import java.time.LocalDateTime;

public record MyPostListItemResponse(
        Long id,
        String title,
        String excerpt,
        String thumbnailUrl,
        @JsonFormat(
                shape = JsonFormat.Shape.STRING,
                pattern = "yyyy-MM-dd'T'HH:mm:ss",
                timezone = "Asia/Seoul"
        )
        LocalDateTime createdAt
) {}


========== FILE PATH: C:\Users\Booj\Desktop\2차프로젝트\2차프로젝트(머지)\backend\src\main\java\com\mysite\knitly\domain\mypage\dto\OrderCardResponse.java ==========
package com.mysite.knitly.domain.mypage.dto;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

public record OrderCardResponse(
        Long orderId,
        LocalDateTime orderedAt,
        Double totalPrice,
        List<OrderLine> items
) {
    public static OrderCardResponse of(Long orderId, LocalDateTime orderedAt, Double totalPrice) {
        return new OrderCardResponse(orderId, orderedAt, totalPrice, new ArrayList<>());
    }
}


========== FILE PATH: C:\Users\Booj\Desktop\2차프로젝트\2차프로젝트(머지)\backend\src\main\java\com\mysite\knitly\domain\mypage\dto\OrderLine.java ==========
package com.mysite.knitly.domain.mypage.dto;

public record OrderLine(
        Long orderItemId,
        Long productId,
        String productTitle,
        int quantity,
        Double orderPrice,
        boolean isReviewed
) {}


========== FILE PATH: C:\Users\Booj\Desktop\2차프로젝트\2차프로젝트(머지)\backend\src\main\java\com\mysite\knitly\domain\mypage\dto\PageResponse.java ==========
package com.mysite.knitly.domain.mypage.dto;

import org.springframework.data.domain.Page;
import java.util.List;

public record PageResponse<T>(
        List<T> content,
        int page,
        int size,
        long totalElements,
        int totalPages,
        boolean first,
        boolean last
) {
    public static <T> PageResponse<T> of(Page<T> p) {
        return new PageResponse<>(
                p.getContent(),
                p.getNumber(),
                p.getSize(),
                p.getTotalElements(),
                p.getTotalPages(),
                p.isFirst(),
                p.isLast()
        );
    }
}


========== FILE PATH: C:\Users\Booj\Desktop\2차프로젝트\2차프로젝트(머지)\backend\src\main\java\com\mysite\knitly\domain\mypage\dto\ProfileResponse.java ==========
package com.mysite.knitly.domain.mypage.dto;

public record ProfileResponse(String name, String email) {}


========== FILE PATH: C:\Users\Booj\Desktop\2차프로젝트\2차프로젝트(머지)\backend\src\main\java\com\mysite\knitly\domain\mypage\dto\ReviewListItem.java ==========
package com.mysite.knitly.domain.mypage.dto;

import java.time.LocalDate;
import java.util.List;

public record ReviewListItem(
        Long reviewId,
        Long productId,
        String productTitle,
        String productThumbnailUrl,
        Integer rating,
        String content,
        List<String> reviewImageUrls,// 프론트에서 접기/펼치기
        LocalDate createdDate
) {}


========== FILE PATH: C:\Users\Booj\Desktop\2차프로젝트\2차프로젝트(머지)\backend\src\main\java\com\mysite\knitly\domain\mypage\repository\MyPageQueryRepository.java ==========
package com.mysite.knitly.domain.mypage.repository;

import com.mysite.knitly.domain.mypage.dto.*;
import jakarta.persistence.EntityManager;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Repository;

import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

@Repository
@RequiredArgsConstructor
public class MyPageQueryRepository {

    private final EntityManager em;

    // 주문 내역 조회
    public Page<OrderCardResponse> findOrderCards(Long userId, Pageable pageable) {
        String jpql = """
            select o.orderId, o.createdAt, o.totalPrice,
                   p.productId, p.title,
                   oi.quantity, oi.orderPrice,
                   oi.orderItemId
            from Order o
            join o.orderItems oi
            join oi.product p
            where o.user.userId = :uid
            order by o.createdAt desc
        """;

        List<Object[]> rows = em.createQuery(jpql, Object[].class)
                .setParameter("uid", userId)
                .setFirstResult((int) pageable.getOffset())
                .setMaxResults(pageable.getPageSize())
                .getResultList();

        long total = em.createQuery("select count(o) from Order o where o.user.userId = :uid", Long.class)
                .setParameter("uid", userId)
                .getSingleResult();

        if (rows.isEmpty()) {
            return new PageImpl<>(List.of(), pageable, total);
        }

        Set<Long> productIdsInOrders = rows.stream()
                .map(r -> (Long) r[3])
                .collect(Collectors.toSet());

        Set<Long> orderItemIds = rows.stream()
                .map(r -> (Long) r[7])
                .collect(Collectors.toSet());

        Set<Long> reviewedOrderItemIds = new HashSet<>(em.createQuery("""
                    select r.orderItem.orderItemId from Review r
                    where r.user.userId = :userId 
                      and r.orderItem.orderItemId in :orderItemIds
                    """, Long.class)
                .setParameter("userId", userId)
                .setParameter("orderItemIds", orderItemIds)
                .getResultList());

        Map<Long, LocalDateTime> orderedAtMap = new LinkedHashMap<>();
        Map<Long, Double> totalMap = new LinkedHashMap<>();
        Map<Long, List<OrderLine>> itemsMap = new LinkedHashMap<>();

        for (Object[] r : rows) {
            Long oId = (Long) r[0];
            LocalDateTime orderedAt = (LocalDateTime) r[1];
            Double totalPrice = (r[2] == null) ? 0d : ((Number) r[2]).doubleValue();
            Long productId = (Long) r[3];
            String productTitle = (String) r[4];
            Integer quantity = (Integer) r[5];
            Double orderPrice = (r[6] == null) ? 0d : ((Number) r[6]).doubleValue();
            Long orderItemId = (Long) r[7];

            orderedAtMap.putIfAbsent(oId, orderedAt);
            totalMap.putIfAbsent(oId, totalPrice);

            boolean isReviewed = reviewedOrderItemIds.contains(orderItemId);

            itemsMap.computeIfAbsent(oId, k -> new ArrayList<>())
                    .add(new OrderLine(orderItemId, productId, productTitle, quantity, orderPrice, isReviewed));
        }

        List<OrderCardResponse> cards = new ArrayList<>();
        for (Long id : itemsMap.keySet()) {
            cards.add(new OrderCardResponse(
                    id,
                    orderedAtMap.get(id),
                    totalMap.get(id),
                    Collections.unmodifiableList(itemsMap.get(id))
            ));
        }

        return new PageImpl<>(cards, pageable, total);
    }

    // 수정: 내가 쓴 글 조회 - CAST를 사용하여 CLOB → VARCHAR 변환
    public Page<MyPostListItemResponse> findMyPosts(Long userId, String query, Pageable pageable) {
        String base = """
                SELECT new com.mysite.knitly.domain.mypage.dto.MyPostListItemResponse(
                    p.id,
                    p.title,
                    CASE WHEN LENGTH(CAST(p.content AS string)) > 10 
                         THEN CONCAT(SUBSTRING(CAST(p.content AS string), 1, 10), '...')
                         ELSE CAST(p.content AS string)
                    END,
                    (SELECT MIN(i) FROM Post p2 JOIN p2.imageUrls i WHERE p2 = p),
                    p.createdAt
                )
                FROM Post p
                WHERE p.author.userId = :uid
                  AND p.deleted = false
                """;

        if (query != null && !query.isBlank()) {
            base += " AND (LOWER(p.title) LIKE LOWER(CONCAT('%', :q, '%')) OR LOWER(CAST(p.content AS string)) LIKE LOWER(CONCAT('%', :q, '%')))";
        }

        var q = em.createQuery(base + " ORDER BY p.createdAt DESC", MyPostListItemResponse.class)
                .setParameter("uid", userId);

        if (query != null && !query.isBlank()) {
            q.setParameter("q", query.trim());
        }

        List<MyPostListItemResponse> list = q
                .setFirstResult((int) pageable.getOffset())
                .setMaxResults(pageable.getPageSize())
                .getResultList();

        long total = em.createQuery("""
                        SELECT COUNT(p.id)
                        FROM Post p
                        WHERE p.author.userId = :uid AND p.deleted = false
                        """, Long.class)
                .setParameter("uid", userId)
                .getSingleResult();

        return new PageImpl<>(list, pageable, total);
    }

    // 최종 수정: 내가 쓴 댓글 조회 - LocalDate로 CAST
    public Page<MyCommentListItem> findMyComments(Long userId, String query, Pageable pageable) {
        String base = """
                SELECT new com.mysite.knitly.domain.mypage.dto.MyCommentListItem(
                    c.id,
                    c.post.id,
                    c.createdAt,
                    CASE WHEN LENGTH(CAST(c.content AS string)) > 30\s
                         THEN CONCAT(SUBSTRING(CAST(c.content AS string), 1, 30), '...')
                         ELSE CAST(c.content AS string)
                    END
                )
                FROM Comment c
                WHERE c.author.userId = :uid
                  AND c.deleted = false
                  AND c.post.deleted = false
                """;

        if (query != null && !query.isBlank()) {
            base += " AND LOWER(CAST(c.content AS string)) LIKE LOWER(CONCAT('%', :q, '%'))";
        }

        var q = em.createQuery(base + " ORDER BY c.createdAt DESC", MyCommentListItem.class)
                .setParameter("uid", userId);

        if (query != null && !query.isBlank()) {
            q.setParameter("q", query.trim());
        }

        List<MyCommentListItem> list = q
                .setFirstResult((int) pageable.getOffset())
                .setMaxResults(pageable.getPageSize())
                .getResultList();

        long total = em.createQuery("""
                        SELECT COUNT(c.id)
                        FROM Comment c
                        WHERE c.author.userId = :uid AND c.deleted = false
                        """, Long.class)
                .setParameter("uid", userId)
                .getSingleResult();

        return new PageImpl<>(list, pageable, total);
    }
}

========== FILE PATH: C:\Users\Booj\Desktop\2차프로젝트\2차프로젝트(머지)\backend\src\main\java\com\mysite\knitly\domain\mypage\service\MyPageService.java ==========
package com.mysite.knitly.domain.mypage.service;

import com.mysite.knitly.domain.mypage.dto.*;
import com.mysite.knitly.domain.mypage.repository.MyPageQueryRepository;
import com.mysite.knitly.domain.product.like.entity.ProductLike;
import com.mysite.knitly.domain.product.like.repository.ProductLikeRepository;
import com.mysite.knitly.domain.product.review.entity.Review;
import com.mysite.knitly.domain.product.review.repository.ReviewRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Slf4j
@Service
@RequiredArgsConstructor
public class MyPageService {

    private final MyPageQueryRepository repo;
    private final ReviewRepository reviewRepository;
    private final ProductLikeRepository productLikeRepository;

    // 주문 내역 조회
    @Transactional(readOnly = true)
    public Page<OrderCardResponse> getOrderCards(Long userId, Pageable pageable) {
        log.info("[MyPageService] 주문 내역 조회 - userId={}, page={}, size={}", userId, pageable.getPageNumber(), pageable.getPageSize());
        Page<OrderCardResponse> page = repo.findOrderCards(userId, pageable);
        log.info("[MyPageService] 주문 내역 조회 완료 - userId={}, totalElements={}", userId, page.getTotalElements());
        return page;
    }

    // 내가 쓴 글 조회
    @Transactional(readOnly = true)
    public Page<MyPostListItemResponse> getMyPosts(Long userId, String query, Pageable pageable) {
        log.info("[MyPageService] 내 글 조회 - userId={}, query='{}', page={}, size={}", userId, query, pageable.getPageNumber(), pageable.getPageSize());
        Page<MyPostListItemResponse> page = repo.findMyPosts(userId, query, pageable);
        log.info("[MyPageService] 내 글 조회 완료 - userId={}, totalElements={}", userId, page.getTotalElements());
        return page;
    }

    // 내가 쓴 댓글 조회
    @Transactional(readOnly = true)
    public Page<MyCommentListItem> getMyComments(Long userId, String query, Pageable pageable) {
        log.info("[MyPageService] 내 댓글 조회 - userId={}, query='{}', page={}, size={}", userId, query, pageable.getPageNumber(), pageable.getPageSize());
        Page<MyCommentListItem> page = repo.findMyComments(userId, query, pageable);
        log.info("[MyPageService] 내 댓글 조회 완료 - userId={}, totalElements={}", userId, page.getTotalElements());
        return page;
    }

    // 내가 찜한 상품 조회
    @Transactional(readOnly = true)
    public Page<FavoriteProductItem> getMyFavorites(Long userId, Pageable pageable) {
        log.info("[MyPageService] 찜 목록 조회 - userId={}, page={}, size={}", userId, pageable.getPageNumber(), pageable.getPageSize());
        Page<FavoriteProductItem> page = productLikeRepository.findByUser_UserId(userId, pageable)
                .map(this::convertToDto);
        log.info("[MyPageService] 찜 목록 조회 완료 - userId={}, totalElements={}", userId, page.getTotalElements());
        return page;
    }

    private FavoriteProductItem convertToDto(ProductLike pl) {
        var p = pl.getProduct();

        String thumbnailUrl = p.getProductImages().isEmpty()
                ? null
                : p.getProductImages().get(0).getProductImageUrl(); // 첫 번째 이미지

        return new FavoriteProductItem(
                p.getProductId(),
                p.getTitle(),
                p.getUser().getName(),
                thumbnailUrl
        );
    }

    // 사용자가 작성한 리뷰 조회
    @Transactional(readOnly = true)
    public Page<ReviewListItem> getMyReviewsV2(Long userId, Pageable pageable) {
        log.info("[MyPageService] 내 리뷰 조회 - userId={}, page={}, size={}", userId, pageable.getPageNumber(), pageable.getPageSize());

        List<Review> reviews = reviewRepository.findByUser_UserIdAndIsDeletedFalse(userId, pageable);

        List<ReviewListItem> list = reviews.stream().map(r -> {
            var product = r.getProduct();
            String productThumbnail = product.getProductImages().isEmpty() ? null :
                    product.getProductImages().get(0).getProductImageUrl();

            List<String> reviewImages = r.getReviewImages().stream()
                    .map(ri -> ri.getReviewImageUrl())
                    .toList();

            return new ReviewListItem(
                    r.getReviewId(),
                    product.getProductId(),
                    product.getTitle(),
                    productThumbnail,
                    r.getRating(),
                    r.getContent(),
                    reviewImages,
                    r.getCreatedAt().toLocalDate()
            );
        }).toList();

        long total = reviewRepository.countByUser_UserIdAndIsDeletedFalse(userId);
        log.info("[MyPageService] 내 리뷰 조회 완료 - userId={}, totalElements={}", userId, total);

        return new PageImpl<>(list, pageable, total);
    }
}



